#!/bin/bash

# This instance-specific script is supposed to be sourced from the Qserv
# management scripts in order to set up proper values of the corresponding
# parameters.

# -----------------
# ----- Qserv -----
# -----------------

QSERV_DB_IMAGE_TAG="qserv/lite-mariadb:2021.10.1-lite-rc2"

# The latest stable release.
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-lite-rc2"

# John's latest tag based on the PR of https://jira.lsstcorp.org/browse/DM-31537
# that that puts back the "LIMIT N" optimization implemented
# in https://jira.lsstcorp.org/browse/DM-30942
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-84-ga799207f0"

# Same as above. Plus FIFO at "czar".
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-85-gf2b3b0f11"

# Not rebased
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-91-g2ada1c49d"

# rebased off main
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-162-ge6bb9589d-dirty"

# rebase off main with limit n fix.
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-163-g67cac7a8a-dirty"

# rebase off main with limit n fix and wroker doesn't allow nn to be interactive
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-164-g2285eb430-dirty"

# The latest version of Qserv that includes what's mentioned above
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.1.1-rc1-60-g9784d9d0b"

# DM-33346: near neighbor optimization test
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.2.1-rc1-25-g7ffeaf5a6"

# DM-34321: fixing a bug in truncating subseconds in values of DATETIME(N)
#           and TIMESTAMP(N)
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.2.1-rc1-49-ge9c4ee409"

# DM-34719: Added support for the spatial (GEOMETRY) column type
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.4.2-rc1-51-gd27134a20"

# DM-34464: Qserv query processor should retain error codes/conditions for failed
#           queries.
# NOTE: The previous tag DM-34719 is still not a part of this.
# ATTENTION: Schema version change of qservMeta from 4 to 5.
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.4.2-rc1-53-gface89d3b"

# DM-34747: Add support to Qserv for standalone boolean value
#           expressions in WHERE clauses
# ATTENTION: Pulling back schema version of qservMeta from 5 to 4.
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.4.2-rc1-60-g49921c01f"

# DM-34624: Implement optimization for simple SELECT COUNT(*) in qserv.
#           Fully implemented and merged into the main branch.
#           Based on th eoriginal proposal outlined in DM-32600.
# ATTENTION: Pulling back schema version of qservMeta from 5 to 4 since
#            DM-34464 hasn't been merged into the "main" branch.
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.5.1-rc1-13-gedd0c4848"

# DM-34464: Another iteration of the ticket. More schema changes
#           adding 3 new columns to existing table qservMeta.QInfo
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.5.2-rc1-7-g24f6d61df"

# DM-34464: Another iteration of the ticket. More schema changes
#           changed types of columns in the new table qservMeta.QMessages.
QSERV_IMAGE_TAG="qserv/lite-qserv:2022.5.2-rc1-14-g906ce1fa2"

QSERV_BASE_DIR="/qserv/qserv-dev"
QSERV_CZAR_DB_PORT=3306
QSERV_WORKER_DB_PORT=3306
QSERV_XROOTD_PORT=1094

# -------------------------------------
# ----- Replication/Ingest system -----
# -------------------------------------

# Version 10.4.21
# REPL_DB_IMAGE_TAG="qserv/lite-mariadb:2021.10.1-lite-rc2"

# Version 10.6.5
REPL_DB_IMAGE_TAG="qserv/lite-mariadb:2022.2.1-rc1"

# DM-32810: Replication system's workers should learn their identity
#           from the Qserv worker databases.
# REPL_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-83-geb1646869"

# DM-32885: Worker-side CMSD should learn their identity
#           from the Qserv worker databases. Also includes
#           a fix in QHTTP to prevent crashes caused by the security
#           scanner.
# REPL_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-115-ga4fea21d6"

# DM-33376: Registry-based Controller-workers protocol in the Qserv
#           Replication/Ingest system
# REPL_IMAGE_TAG="qserv/lite-qserv:2022.1.1-rc1-83-gb68ecf8b2"

# DM-33815: Although, this particular ticket captures some new development
#           that doesn't affect yet the functionality of the R-I system,
#           the branch also carries a nore robus implementation of the
#           qhttp server from the main branch. This should prevent crashes
#           of the R-I services due to NCSA security scanner.
# REPL_IMAGE_TAG="qserv/lite-qserv:2022.2.1-rc1-28-g80de6f7cc"

# DM-34085: Extended transaction states and refined transaction management.
#           ATTENTION: schema change to version 9 is required. 
# REPL_IMAGE_TAG="qserv/lite-qserv:2022.4.2-rc1-15-ga6f7cb392"

# DM-30885: fixes to the Web Dashboard. Includes previous tags.
REPL_IMAGE_TAG="qserv/lite-qserv:2022.5.1-rc1-13-gedd0c4848-dirty"

REPL_INSTANCE_ID="large6:qserv-dev"
REPL_BASE_DIR="${QSERV_BASE_DIR}/replication"
REPL_DB_PORT=23306
REPL_CONTR_HTTP_PORT=25081
REPL_REG_PORT=25082
REPL_REG_PARAMETERS="--registry-port=${REPL_REG_PORT} --debug"
REPL_CONTR_PARAMETERS="--registry-port=${REPL_REG_PORT} --xrootd-port=${QSERV_XROOTD_PORT} --controller-http-server-port=${REPL_CONTR_HTTP_PORT} --http-root=/usr/local/qserv/www/ --worker-evict-timeout=3600 --health-probe-interval=120 --replication-interval=600 --qserv-sync-timeout=600 --do-not-create-folders --controller-ingest-job-monitor-ival-sec=1 --debug"
REPL_WORKER_SVC_PORT=25000
REPL_WORKER_FS_PORT=25001
REPL_WORKER_LOADER_PORT=25002
REPL_WORKER_EXPORTER_PORT=25003
REPL_WORKER_HTTP_LOADER_PORT=25004
REPL_WORKER_PARAMETERS="--registry-port=${REPL_REG_PORT} --worker-svc-port=${REPL_WORKER_SVC_PORT} --worker-fs-port=${REPL_WORKER_FS_PORT} --worker-loader-port=${REPL_WORKER_LOADER_PORT} --worker-exporter-port=${REPL_WORKER_EXPORTER_PORT} --worker-http-loader-port=${REPL_WORKER_HTTP_LOADER_PORT} --schema-upgrade-wait=1 --schema-upgrade-wait-timeout=600 --do-not-create-folders --debug"
REPL_LSST_LOG_CONFIG="log4cxx.replication.properties"
# To mount the local (ouside the container) version of the Web dashboard
# and other Web apps served by the HTTP server of the Master Conbtroller 
REPL_HTTP_ROOT="${QSERV_BASE_DIR}/dashboard/qserv/src/www"

# Limit size of the replication containers by 40 GB
REPL_MEMORY_LIMIT=42949672960

# ----- Common parameters

CONTAINER_NAME_PREFIX="qserv-6-"
CORE_FILES_BASE_DIR="${QSERV_BASE_DIR}/core-files"
LOG_DIR="${QSERV_BASE_DIR}/log"

# 10 GB
ULIMIT_MEMLOCK=10995116277760

# Other parameters are set by the following script based on the above defined
# one, or be loaded from predefined locations.
. $(dirname "$0")/../../bin/common
