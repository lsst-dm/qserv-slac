#!/bin/bash

# This instance-specific script is supposed to be sourced from the Qserv
# management scripts in order to set up proper values of the corresponding
# parameters.

# -----------------
# ----- Qserv -----
# -----------------

# 10.4.21
# QSERV_DB_IMAGE_TAG="qserv/lite-mariadb:2021.10.1-lite-rc2"
# 10.6.5
QSERV_DB_IMAGE_TAG="qserv/lite-mariadb:2022.1.1-rc1"

# The latest stable release.
# QSERV_IMAGE_TAG="qserv/lite-qserv:2021.10.1-lite-rc2"
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.1.1-rc1"
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.4.2-rc1"
# QSERV_IMAGE_TAG="qserv/lite-qserv:2022.5.1-rc1"
QSERV_IMAGE_TAG="qserv/lite-qserv:2022.5.2-rc1"

QSERV_BASE_DIR="/qserv/qserv-prod"
QSERV_CZAR_DB_PORT=3306
QSERV_WORKER_DB_PORT=3306

# -------------------------------------
# ----- Replication/Ingest system -----
# -------------------------------------

REPL_DB_IMAGE_TAG="qserv/lite-mariadb:2021.10.1-lite-rc2"

# DM-32810: Replication system's workers should learn their identity
#           from the Qserv worker databases.
# REPL_IMAGE_TAG="qserv/lite-qserv:2021.10.1-rc1-83-geb1646869"

# DM-30885: fixes to the Web Dashboard. Includes previous tags.
# REPL_IMAGE_TAG="qserv/lite-qserv:2022.5.1-rc1-13-gedd0c4848-dirty"

# DM-34979: Deleting any tables from Qserv catalogs should be allowed.
# REPL_IMAGE_TAG="qserv/lite-qserv:2022.5.2-rc1-18-gb95b4c5b4"

# DM-28626: reopening catalogs to add more tables, excluding published
#           tables from the operations.
#           ATTENTION: Replication database schema changes to version 10 
#           in DM-34979.
REPL_IMAGE_TAG="qserv/lite-qserv:2022.5.2-rc1-29-g1c42476c7"

REPL_INSTANCE_ID="small:qserv-prod"
REPL_BASE_DIR="${QSERV_BASE_DIR}/replication"
REPL_DB_PORT=23306
REPL_CONTR_HTTP_PORT=25081
REPL_REG_PORT=25082
REPL_REG_PARAMETERS="--registry-port=${REPL_REG_PORT} --debug"
# Extended Controller timeouts to allow long operation when ingesting
# large catalogs:
#   request timeout: 8 hours
#   job timeout: 24 hours
REPL_CONTR_PARAMETERS="--registry-port=${REPL_REG_PORT} --xrootd-port=${QSERV_XROOTD_PORT} --controller-http-server-port=${REPL_CONTR_HTTP_PORT} --http-root=/usr/local/qserv/www/ --worker-evict-timeout=3600 --health-probe-interval=120 --replication-interval=600 --qserv-sync-timeout=600 --do-not-create-folders --controller-ingest-job-monitor-ival-sec=1 --controller-request-timeout-sec=28800 --controller-job-timeout-sec=86400 --debug"
REPL_WORKER_SVC_PORT=25000
REPL_WORKER_FS_PORT=25001
REPL_WORKER_LOADER_PORT=25002
REPL_WORKER_EXPORTER_PORT=25003
REPL_WORKER_HTTP_LOADER_PORT=25004
REPL_WORKER_PARAMETERS="--registry-port=${REPL_REG_PORT} --worker-svc-port=${REPL_WORKER_SVC_PORT} --worker-fs-port=${REPL_WORKER_FS_PORT} --worker-loader-port=${REPL_WORKER_LOADER_PORT} --worker-exporter-port=${REPL_WORKER_EXPORTER_PORT} --worker-http-loader-port=${REPL_WORKER_HTTP_LOADER_PORT} --schema-upgrade-wait=1 --schema-upgrade-wait-timeout=600 --do-not-create-folders --debug"
REPL_LSST_LOG_CONFIG="log4cxx.replication.properties"

# To mount the local (ouside the container) version of the Web dashboard
# and other Web apps served by the HTTP server of the Master Conbtroller 
# REPL_HTTP_ROOT="${QSERV_BASE_DIR}/dashboard/qserv/src/www"

# Limit size of the replication containers by 100 GB
# This is needed for ingesting (very) large numbers of contributions.
REPL_MEMORY_LIMIT=107374182400

# ----- Common parameters

CONTAINER_NAME_PREFIX="qserv-"
CORE_FILES_BASE_DIR="${QSERV_BASE_DIR}/core-files"
LOG_DIR="${QSERV_BASE_DIR}/log"

# 10 GB
ULIMIT_MEMLOCK=10995116277760

# Other parameters are set by the following script based on the above defined
# one, or be loaded from predefined locations.
. $(dirname "$0")/../../bin/common

